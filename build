#! /usr/bin/env bash
# Copyright 2019- <fastype.org>
# Apache License Version 2.0

# ---- library ----

ROOT=`pwd`
FOS=$(bash -c "echo \$OSTYPE")

function init_macos() {
    echo [fastype] prepare compiler and toolchain through homebrew
    brew install cmake automake autoconf
    echo [fastype] prepare compiler and toolchain through homebrew - done
    echo [fastype] prepare spdlog, fmt, boost, icu4c, gperftools, ncurses through homebrew
    brew install spdlog fmt boost icu4c gperftools ncurses
    echo [fastype] prepare spdlog, fmt, boost, icu4c, gperftools, ncurses through homebrew - done
}

function init_bsd() {
    sudo echo [fastype] prepare compiler and toolchain through pkg || { echo [fastype] sudo not found; exit 3; }
    sudo pkg install -y cmake automake autoconf
    echo [fastype] prepare compiler and toolchain through pkg - done
    echo [fastype] prepare spdlog, libfmt, boost-all, icu, ncurses through pkg
    sudo pkg install -y spdlog libfmt boost-all icu ncurses
    echo [fastype] prepare spdlog, libfmt, boost-all, icu, ncurses through pkg - done
}

function init_apt() {
    sudo echo [fastype] prepare compiler and toolchain through apt || { echo [fastype] sudo not found; exit 3; }
    sudo apt-get install -y gcc g++ make cmake automake autoconf
    echo [fastype] prepare compiler and toolchain through apt - done
    echo [fastype] prepare libboost-all-dev, libicu-dev, libgoogle-perftools-dev, libncurses-dev through apt
    sudo apt-get install -y libboost-all-dev libicu-dev libgoogle-perftools-dev libncurses-dev
    echo [fastype] prepare libboost-all-dev, libicu-dev, libgoogle-perftools-dev, libncurses-dev through apt - done
}

function init_dnf() {
    sudo echo [fastype] prepare compiler and toolchain through dnf || { echo [fastype] sudo not found; exit 3; }
    sudo dnf install -y gcc g++ make cmake automake autoconf
    echo [fastype] prepare compiler and toolchain through dnf - done
    echo [fastype] prepare boost-devel, libicu-devel, gperftools-devel, ncurses-devel through dnf
    sudo dnf install -y boost-devel libicu-devel gperftools-devel ncurses-devel
    echo [fastype] prepare boost-devel, libicu-devel, gperftools-devel, ncurses-devel through dnf - done
}

function init_pacman() {
    sudo echo [fastype] prepare compiler and toolchain through pacman || { echo [fastype] sudo not found; exit 3; }
    yes | sudo pacman -S gcc make cmake automake autoconf
    echo [fastype] prepare compiler and toolchain through pacman - done
    echo [fastype] prepare boost, icu, gperftools, ncurses through pacman
    yes | sudo pacman -S boost icu gperftools ncurses
    echo [fastype] prepare boost, icu, gperftools, ncurses through pacman - done
}

function init_zypper() {
    sudo echo [fastype] prepare compiler and toolchain through zypper || { echo [fastype] sudo not found; exit 3; }
    sudo zypper install -y gcc gcc-c++ gcc-32bit gcc-c++-32bit make cmake automake autoconf
    echo [fastype] prepare compiler and toolchain through zypper - done
    echo [fastype] prepare libboost-devel, libicu-devel, gperftools-devel, ncurses-devel through zypper
    sudo zypper install -y libboost*-devel libboost*-32bit libicu-devel libicu-devel-32bit gperftools-devel ncurses-devel ncurses-devel-32bit
    echo [fastype] prepare libboost-devel, libicu-devel, gperftools-devel, ncurses-devel through zypper - done
}

function init_linux() {
    cd $ROOT
    echo [fastype] prepare gabime/spdlog v1.3.1
    if [ ! -d src/spdlog ]; then
        cd src && git clone -b 'v1.3.1' --single-branch --depth 1 https://github.com/gabime/spdlog.git && cd ..
    fi
    echo [fastype] prepare gabime/spdlog v1.3.1 - done
    echo [fastype] prepare fmtlib/fmt 5.3.0
    if [ ! -d src/fmt ]; then
        cd src && git clone -b '5.3.0' --single-branch --depth 1 https://github.com/fmtlib/fmt.git && cd ..
    fi
    echo [fastype] prepare fmtlib/fmt 5.3.0 - done
    if [ $(uname) == "Linux" ]; then
        if cat /etc/*release | grep ^NAME | grep Ubuntu 1>/dev/null 2>&1; then
            init_apt
        elif cat /etc/*release | grep ^NAME | grep Debian 1>/dev/null 2>&1; then
            init_apt
        elif cat /etc/*release | grep ^NAME | grep Fedora 1>/dev/null 2>&1; then
            init_dnf
        elif cat /etc/*release | grep ^NAME | grep Manjaro 1>/dev/null 2>&1; then
            init_pacman
        elif cat /etc/*release | grep ^NAME | grep openSUSE 1>/dev/null 2>&1; then
            init_zypper
        else
            echo [fastype] Error! Unknown Operating System $(uname)! && exit 3
        fi
    else
        echo [fastype] Error! Unknown Operating System $(uname)! && exit 3
    fi
}

function init_all() {
    cd $ROOT
    echo [fastype] prepare catchorg/Catch2 v2.9.1
    if [ ! -d test/Catch2 ]; then
        cd test && git clone -b 'v2.9.1' --single-branch --depth 1 https://github.com/catchorg/Catch2.git && cd ..
    fi
    echo [fastype] prepare catchorg/Catch2 v2.9.1 - done
    echo [fastype] prepare nlohmann/json v3.7.0
    if [ ! -d src/json ]; then
        cd src && git clone -b 'v3.7.0' --single-branch --depth 1 https://github.com/nlohmann/json.git && cd ..
    fi
    echo [fastype] prepare nlohmann/json v3.7.0 - done
}

function clean_all() {
    cd $ROOT
    rm *.log >>/dev/null 2>&1
    if [ -d debug ]; then cd debug && make clean && cd ..; fi
    if [ -d release ]; then cd release && make clean && cd ..; fi
}

function purge_all() {
    cd $ROOT
    rm *.log >>/dev/null 2>&1
    if [ -d debug ]; then rm -rf debug>>/dev/null 2>&1; fi
    if [ -d release ]; then rm -rf release>>/dev/null 2>&1; fi
}

function build_debug() {
    cd $ROOT/src
    flex -d -o Token.yy.cpp Token.l
    bison -d -o Parser.tab.cpp Parser.y
    cd $ROOT/example
    flex -d -o flex.yy.cpp flex.l
    bison -d -o bison.tab.cpp bison.y

    cd $ROOT
    DEBUG=debug
    if [ ! -d $DEBUG ]; then mkdir $DEBUG; fi

    case "$FOS" in
      solaris*) echo "[fastype] Solaris Not Support!" && exit 3 ;;
      darwin*)  ;;
      linux*)   ;;
      *bsd*)    ;;
      *)        echo "[fastype] Unknown OS: $FOS!" && exit 3 ;;
    esac
    echo [fastype] prepare for $FOS

    cd $DEBUG
    cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON .. && make VERBOSE=1
    cd $ROOT
}

function build_release() {
    cd $ROOT/src
    flex -o Token.yy.cpp Token.l
    bison -d -o Parser.tab.cpp Parser.y
    cd $ROOT/example
    flex -o flex.yy.cpp flex.l
    bison -d -o bison.tab.cpp bison.y

    cd $ROOT
    RELEASE=release
    if [ ! -d $RELEASE ]; then mkdir $RELEASE; fi

    case "$FOS" in
      solaris*) echo "[fastype] Solaris Not Support!" && exit 3 ;;
      darwin*)  ;;
      linux*)   ;;
      *bsd*)    ;;
      *)        echo "[fastype] Unknown OS: $FOS!" && exit 3 ;;
    esac
    echo [fastype] prepare for $FOS

    cd $RELEASE && cmake -DCMAKE_BUILD_TYPE=Release .. && make && cd $ROOT
    cd $ROOT
}

function build_help() {
    echo [fastype] help message:
    echo   1. build help    - show help message.
    echo   2. build init    - initialize third party dependencies.
    echo   3. build debug   - build debug version.
    echo   4. build release - build release version.
    echo   5. build all     - build both debug and release version.
    echo   6. build install - build and install.
    echo   7. build test    - run unit tests.
    echo   8. build clean   - clean build objects.
}

# ---- main ----

if [ "$1" = "help" ]; then
    build_help
    exit 0
fi

if [ "$1" = "init" ]; then
    init_all
    case "$FOS" in
      darwin*)  init_macos ;;
      linux*)   init_linux ;;
      *bsd*)    init_bsd ;;
      *)        ;;
    esac
    exit 0
fi

if [ "$1" = "clean" ]; then
    clean_all
    exit 0
fi

if [ "$1" = "purge" ]; then
    purge_all
    exit 0
fi

if [ "$1" = "install" ]; then
    echo [fastype] error! install not implmented !
    exit 3
fi

if [ "$1" = "test" ]; then
    debug/test/fastype-test
    exit 0
fi

if [ "$1" = "debug" ]; then
    build_debug
    exit 0
fi

if [ "$1" = "release" ]; then
    build_release
    exit 0
fi

if [ "$1" = "all" ]; then
    build_debug
    build_release
    exit 0
fi

if [ "$#" -gt 1 ]; then
    build_help
    exit 0
fi

build_release
