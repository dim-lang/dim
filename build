#! /usr/bin/env bash
# Copyright 2019- <shepherd-lang>
# Apache License Version 2.0

ROOT=`pwd`
FOS=$(bash -c "echo \$OSTYPE")

function check_return() {
    if [ $1 -ne 0 ]; then
        echo [shepherd] $2
        exit $1
    fi
}

function clean_all() {
    cd $ROOT
    rm *.log >>/dev/null 2>&1
    if [ -d debug ]; then cd debug && make clean && cd ..; fi
    if [ -d release ]; then cd release && make clean && cd ..; fi
}

function build_generate() {
    CATCH2_VERSION=v2.9.1
    SPDLOG_VERSION=v1.3.1
    FMTLIB_VERSION=5.3.0
    ENUM_VERSION=0.11.2
    cd $ROOT
    echo [shepherd] prepare catchorg/Catch2 $CATCH2_VERSION
    if [ ! -d test/Catch2 ]; then
        cd test && git clone -b $CATCH2_VERSION --single-branch --depth 1 https://github.com/catchorg/Catch2 && cd $ROOT
    fi
    echo [shepherd] prepare catchorg/Catch2 $CATCH2_VERSION - done
    echo [shepherd] prepare gabime/spdlog $SPDLOG_VERSION
    if [ ! -d src/spdlog ]; then
        cd src && git clone -b $SPDLOG_VERSION --single-branch --depth 1 https://github.com/gabime/spdlog && cd $ROOT
    fi
    echo [shepherd] prepare gabime/spdlog $SPDLOG_VERSION - done
    echo [shepherd] prepare fmtlib/fmt $FMTLIB_VERSION
    if [ ! -d src/fmt ]; then
        cd src && git clone -b $FMTLIB_VERSION --single-branch --depth 1 https://github.com/fmtlib/fmt && cd $ROOT
    fi
    echo [shepherd] prepare fmtlib/fmt $FMTLIB_VERSION - done
    echo [shepherd] prepare aantron/better-enums $ENUM_VERSION
    if [ ! -d src/better-enums ]; then
        cd src && git clone -b $ENUM_VERSION --single-branch --depth 1 https://github.com/aantron/better-enums && cd $ROOT
    fi
    echo [shepherd] prepare aantron/better-enums $ENUM_VERSION - done
}

function build_make() {
    cd $ROOT
    if [ "$1" == "release" ]; then
        if [ ! -d release ]; then mkdir release; fi
        cd release
        cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DCMAKE_BUILD_TYPE=Release .. && cmake --build . --config Release && cp compile_commands.json ..
    else
        if [ ! -d debug ]; then mkdir debug; fi
        cd debug
        cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON .. && cmake --build . --config Debug -- VERBOSE=1 && cp compile_commands.json ..
    fi
    cd $ROOT
}

# $1: trace/debug/release
function build_routine() {
    case "$FOS" in
      solaris*) ;;
      darwin*)  ;;
      linux*)   ;;
      *bsd*)    ;;
      *)        echo "[shepherd] unknown os: $FOS!" && exit 3 ;;
    esac
    echo [shepherd] build for $FOS, mode=$1
    build_generate $1
    build_make $1
}

# $1: install path
function build_install() {
    case "$FOS" in
      solaris*) ;;
      darwin*)  ;;
      linux*)   ;;
      *bsd*)    ;;
      *)        echo "[shepherd] unknown os: $FOS!" && exit 3 ;;
    esac
    echo [shepherd] install for $FOS, INSTALL_PATH=$1
    cd $ROOT
    if [ ! -d release ]; then mkdir release; fi
    cd release
    cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX==$1 .. && cmake --build . --config Release --target INSTALL
}

function build_help() {
    echo '[shepherd] build help message:'
    echo '  ./build -h/--help           show help message.'
    echo '  ./build -r/--release        build release.'
    echo '  ./build -d/--debug          build debug.'
    echo '  ./build --trace             build trace.'
    echo '  ./build -i/--install        install, install path is /usr/local by default.'
    echo '  ./build -p/--path [path]    custom install path.'
    echo '  ./build -t/--test           run unit tests for debug/trace.'
    echo '  ./build -c/--clean          clean objects.'
}

# ---- main ----

BUILD_TYPE=release
INSTALL=0
INSTALL_PATH=/usr/local

while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
        -h|--help)
            build_help
            exit 0
            ;;
        -c|--clean)
            clean_all
            exit 0
            ;;
        -t|--test)
            debug/test/shepherd-test
            exit 0
            ;;
        -d|--debug)
            BUILD_TYPE=debug
            shift
            ;;
        --trace)
            BUILD_TYPE=trace
            shift
            ;;
        -r|--release)
            BUILD_TYPE=release
            shift
            ;;
        -i|--install)
            INSTALL=1
            ;;
        -p|--path)
            shift
            INSTALL_PATH=$1
            shift
            ;;
        *)
            build_help
            exit 0
            ;;
    esac
done

build_routine $BUILD_TYPE
if [[ $INSTALL -gt 0 ]]; then
    build_install $INSTALL_PATH
fi
