#! /usr/bin/env bash
# Copyright 2019- <fastype.org>
# Apache License Version 2.0

ROOT=`pwd`
DEBUG=debug
RELEASE=release

if [ "$1" = "help" ]; then
    echo [fastype] help message:
    echo [fastype]     1. build init    - initialize third party libraries and other dependencies.
    echo [fastype]     2. build         - build all.
    echo [fastype]     3. build install - build and install.
    echo [fastype]     4. build clean   - clean objects.
    exit 0
fi

OS="Unknown-OS"
case "$OSTYPE" in
  solaris*) OS="Solaris" ;;
  darwin*)  OS="MacOSX" ;;
  linux*)   OS="Linux" ;;
  bsd*)     OS="BSD" ;;
  *)        echo "[fastype] error! unknown *$OSTYPE* !" && exit 3 ;;
esac
echo [fastype] prepare for $OS

if [ "$1" = "init" ]; then
    case "$OSTYPE" in
      darwin*)  bash ./build_macos.sh ;;
      linux*)   bash ./build_linux.sh ;;
      *)        ;;
    esac
    echo [fastype] prepare catch2 v2.9.1
    if [ ! -d test/Catch2 ]; then
        cd test && git clone -b 'v2.9.1' --single-branch --depth 1 https://github.com/catchorg/Catch2.git && cd ..
    fi
    echo [fastype] prepare catch2 v2.9.1 - done
    exit 0
fi

if [ "$1" = "clean" ]; then
    rm *.log
    cd $DEBUG && make clean && cd $ROOT
    cd $RELEASE && make clean && cd $ROOT
    exit 0
fi

if [ "$1" = "install" ]; then
    echo [fastype] error! install not implmented !
    exit 3
fi

# build
cd $ROOT
if [ ! -d $DEBUG ]; then mkdir $DEBUG; fi
if [ ! -d $RELEASE ]; then mkdir $RELEASE; fi

cd $DEBUG && cmake -DF_OS=$OS -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON .. && make VERBOSE=1 && cd $ROOT
cd $RELEASE && cmake -DF_OS=$OS -DCMAKE_BUILD_TYPE=Release .. && make -j8 && cd $ROOT
