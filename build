#! /usr/bin/env bash
# Copyright 2019- <fastype.org>
# Apache License Version 2.0


OS="Unknown-OS"
ROOT=`pwd`
case "$OSTYPE" in
  solaris*) OS="Solaris" ;;
  darwin*)  OS="MacOSX" ;; 
  linux*)   OS="Linux" ;;
  bsd*)     OS="BSD" ;;
  *)        echo "[fastype] Unknown *$OSTYPE* Not Support!" && exit 3 ;;
esac
echo "[fastype] Build for $OS"

cd src
if [ ! -d spdlog ]; then
    echo [fastype] prepare *spdlog* v1.3.1
    git clone https://github.com/gabime/spdlog.git
    cd spdlog && git checkout v1.3.1 && cd $ROOT/src
    echo [fastype] prepare *spdlog* v1.3.1 - done
fi
if [ ! -d fmt ]; then
    echo [fastype] prepare *fmt* v5.3.0
    git clone https://github.com/fmtlib/fmt.git
    cd fmt && git checkout v5.3.0 && cd $ROOT/src
    echo [fastype] prepare *fmt* v5.3.0 - done
fi
if [ ! -d icu ]; then
    echo [fastype] prepare *icu4c* release-64-2
    git clone https://github.com/unicode-org/icu.git
    cd icu && git checkout release-64-2 && cd $ROOT/src
    echo [fastype] build *icu4c* release-64-2 manually: https://htmlpreview.github.io/?https://github.com/unicode-org/icu/blob/release-64-2/icu4c/readme.html#HowToBuildWindows
fi
if [ ! -d boost ]; then
    echo [fastype] prepare *boost* boost-1.70.0
    git clone https://github.com/boostorg/boost.git
    cd boost && git checkout boost-1.70.0 && git submodule update --init && ./bootstrap.sh && ./b2 && cd $ROOT/src
    echo [fastype] prepare *boost* boost-1.70.0 - done
fi

# build
cd $ROOT
DEBUG=debug
RELEASE=release
if [ ! -d $DEBUG ]; then mkdir $DEBUG; fi
if [ ! -d $RELEASE ]; then mkdir $RELEASE; fi
cd $DEBUG && cmake -DF_OS=$OS -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON ../src && make VERBOSE=1 && cd $ROOT
cd $RELEASE && cmake -DF_OS=$OS -DCMAKE_BUILD_TYPE=Release ../src && make -j8 && cd $ROOT
